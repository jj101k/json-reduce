#!/usr/bin/env node
const path = require("path")
const crypto = require("crypto")
const fs = require("fs")
const DeduplicateStrings = require("../src/Processor/DeduplicateStrings")
const Reference = require("../src/Processor/Reference")
const DeduplicateStringsSort = require("../src/Processor/DeduplicateStringsSort")
const DeduplicateStringsSortRepass = require("../src/Processor/DeduplicateStringsSortRepass")
const DeduplicateStringsRepass = require("../src/Processor/DeduplicateStringsRepass")

const wd = path.dirname(process.argv[1])
const [filename] = process.argv.slice(2)

function canonicalise_json(contents) {
    return JSON.stringify(JSON.parse(contents))
}

const contents = fs.readFileSync(filename, {encoding: "utf-8"})

const sum = crypto.createHash("sha256").update(canonicalise_json(contents)).digest("base64")
const size = fs.statSync(filename).size
console.log(filename, sum, size)
const testers = {
    reference: Reference,
    deduplicateStrings: DeduplicateStrings,
    deduplicateStringsSort: DeduplicateStringsSort,
    deduplicateStringsRepass: DeduplicateStringsRepass,
    deduplicateStringsSortRepass: DeduplicateStringsSortRepass,
}
for(const [name, codec] of Object.entries(testers)) {
    const a = new Date()
    let encoded = ""
    for(const e of codec.encode(contents)) {
        encoded += e
    }
    const b = new Date()
    let decoded = ""
    for(const d of codec.decode(encoded)) {
        decoded += d
    }
    const c = new Date()

    const sumi = crypto.createHash("sha256").update(canonicalise_json(decoded)).digest("base64")

    if(sumi != sum) {
        console.error(`Fail: ${sumi} != ${sum}`)
    }
    const sizei = encoded.length
    console.log(`${name}: ${sizei} (${sizei * 100 / size}%) ${b-a}ms/${c-b}ms`)
}